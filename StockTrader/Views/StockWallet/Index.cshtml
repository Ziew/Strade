
@using StockTrader.Models
@using StockTrader.App_Start
@model StockTrader.Models.UserStatisticsWithOwnedCompanyInfo

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <!--SignalR script to update the chat page and send messages.-->
    <script>

        $(function () {

            $.ajaxSetup({ cache: false });

            $("a[data-modal]").on("click", function (e) {

                // hide dropdown if any
                $(e.target).closest('.btn-group').children('.dropdown-toggle').dropdown('toggle');


                $('#myModalContent').load(this.href, function () {


                    $('#myModal').modal({
                        /*backdrop: 'static',*/
                        keyboard: true
                    }, 'show');

                    bindForm(this);
                });

                return false;
            });


        });

        function bindForm(dialog) {

            $('form', dialog).submit(function () {
                $.ajax({
                    url: this.action,
                    type: this.method,
                    data: $(this).serialize(),
                    success: function (result) {

                       
                        if (result.Result == "Success") {
                            $('#myModal').modal('hide');
                          
                            location.reload();
                        } else {
                            if(result.Transaction == "Buy")
                            {
                                $('#content-for-transaction').html("<p>You need more money</p>");
                            }
                            else
                            {
                                $('#content-for-transaction').html("<p>You need more stock</p>");
                            }
                        }
                    }
                });
                return false;
            });
        }

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var connection = $.hubConnection();
            var hub = connection.createHubProxy("PricingHub");

            connection.start().done(function () {
                hub.invoke("SubscribePriceStream").done(function (_) { console.log("Subscribed to "); })
                    .fail(function (x) { console.log(x); });
            });

            hub.on("OnNewPrice", function (statistics) {
                var d = $('#' + statistics.symbol).text();

                var num = parseFloat($('#num_' + statistics.symbol).text())  * parseFloat(statistics.value.replace(",", "."));
                var total = 0.0;
             
                var model = @(Html.ToJson(Model.OwnedCompanyInfo));
                for(var i = 0; i < model.length; i++) {
                    if (model[i].companySymbol == statistics.symbol)
                        total = parseFloat(model[i].totalValue);
                }
          
            
               

                var f = parseFloat(d.replace(",", "."));
                var g = parseFloat(statistics.value.replace(",", "."))
                if (f < g) {
                    $('#' + statistics.symbol).html('<span class="text-navy">' + statistics.value + '<i class="fa fa-level-up"></i></span>');
                } else {
                    $('#' + statistics.symbol).html('<span class="text-danger">' + statistics.value + '<i class="fa fa-level-down"></i></span>');
                }
                if (total < num) {
                    $('#chk_' + statistics.symbol).html('<span class="text-navy">' + (1-total/num).toFixed(2) + '%<i class="fa fa-level-up"></i></span>');
                } else {
                    $('#chk_' + statistics.symbol).html('<span class="text-danger">' + (1-num/total).toFixed(2) + '%<i class="fa fa-level-down"></i></span>');
                }

            });
        });


    </script>
}
@{
    ViewBag.Title = "Index";
}
<div id='myModal' class='modal fade in'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='myModalContent'></div>
        </div>
    </div>
</div>
<div class="row">

    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-5">
        <h1>
            <i class="fa fa-bar-chart fa-fw "></i>
            Home
            <small>
                &gt;
                Stock walltet
            </small>
        </h1>
    </div>
</div>

<p></p>

<div class="row">
    <div class="col-lg-3 col-md-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <span class="label label-success pull-right">Monthly</span>
                <h5>All Stock Value</h5>
            </div>
            <div class="ibox-content">
                <h1 class="no-margins">@Model.AllStockValue</h1>
                <div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>
                <small>Total income</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <span class="label label-info pull-right">Annual</span>
                <h5>All Value</h5>
            </div>
            <div class="ibox-content">
                <h1 class="no-margins">@Model.AllValue</h1>
                <div class="stat-percent font-bold text-info">20% <i class="fa fa-level-up"></i></div>
                <small>New orders</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <span class="label label-primary pull-right">Today</span>
                <h5>Income</h5>
            </div>
            <div class="ibox-content">
                <h1 class="no-margins">@Model.Income</h1>
                <div class="stat-percent font-bold text-navy">44% <i class="fa fa-level-up"></i></div>
                <small>New visits</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <span class="label label-danger pull-right">Euro</span>
                <h5>Your Money</h5>
            </div>
            <div class="ibox-content">
                <h1 class="no-margins">@Model.UserMoney</h1>
                <div class="stat-percent font-bold text-danger">38% <i class="fa fa-level-down"></i></div>
                <small>In first month</small>
            </div>
        </div>
    </div>
</div>
<div class="row">

    <div class="col-lg-12">
        <div class="ibox">
            <div class="ibox-title">
                <h3>Current stock</h3>
            </div>
        </div>
    </div>
</div>

<div class="bs-docs-grid">

    <div class="row">


        @foreach (var item in Model.OwnedCompanyInfo)
        {
            <div class="col-lg-3 col-md-4 col-sm4">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>@Html.DisplayFor(modelItem => item.CompanyName)</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                           
                               @*@Html.ActionLink("Delete", "Delete", new TradeModel { CompanySymbol = item.CompanySymbol }, new { data_modal = "", @class = "close-link fa fa-times" }) *@
                            <a data-modal href="@Url.Action("Delete", "StockWallet", new { CompanySymbol = item.CompanySymbol, returnUrl = this.Request.RawUrl })">
                                <i class=" fa fa-times"></i>

                            </a>
                        </div>
                    </div>
                    <div class="ibox-content ibox-heading no-padding">
                        <ul class="list-group">
                            <li class="list-group-item">

                                <h3>
                                    Current
                                    <div class="stat-percent"><span id="@item.CompanySymbol">@Html.DisplayFor(modelItem => item.CurrentValue) </span></div>
                                </h3>
                            </li>
                            <li class="list-group-item">

                                <h3>
                                    Quantity
                                    <div class="stat-percent"><span id=@("num_" + @item.CompanySymbol)>@Html.DisplayFor(modelItem => item.StocksNumber)</span></div>
                                </h3>
                            </li>
                            <li class="list-group-item">

                                <h3>
                                    Total
                                    <div class="stat-percent"><span id="@("chk_"+@item.CompanySymbol)">0%</span></div>
                                </h3>
                            </li>

                        </ul>
                    </div>
                    <div class="ibox-content">
                        <div class="feed-element">
                            <div>
                                <h4>
                                    <a href="@item.Company[0].Link"> <span class="nav-label">@item.Company[0].Header </span></a>
                                </h4>

                            </div>
                            <small class="text-muted">@item.Company[0].PubDate</small>
                        </div>
                    </div>
                   @* <div class="ibox-content">
                        <div class="feed-element">
                            <div>
                                <h4>
                                    <a href="@item.Company[1].Link"> <span class="nav-label">@item.Company[1].Header </span></a>
                                </h4>

                               
                            </div>
                            <small class="text-muted">@item.Company[1].PubDate</small>
                        </div>
                    </div>*@

                    <div class="ibox-content ibox-heading no-padding">
                        <div class="row">
                            <div class="visible-lg visible-md">
                                <div class="col-lg-6 col-md-6 no-padding-right">
                                    @Html.ActionLink( "Buy", "Buy", new TradeModel { CompanySymbol = item.CompanySymbol }, new { data_modal = "", @class = "btn btn-block no-rounded-btn btn-primary btn-lg" } )


                                </div>
                                <div class="col-lg-6 col-md-6 no-padding-left ">
                                    @Html.ActionLink( "Sell", "Sell", new TradeModel { CompanySymbol = item.CompanySymbol }, new { data_modal = "", @class = "btn btn-block no-rounded-btn btn-danger btn-lg" } )


                                </div>
                            </div>
                            <div class="visible-sm">
                                <div class="col-sm-12">
                                    @Html.ActionLink( "Buy", "Buy", new TradeModel { CompanySymbol = item.CompanySymbol }, new { data_modal = "", @class = "btn btn-block no-rounded-btn btn-primary btn-lg" } )
                                </div>
                                <div class="col-sm-12 ">
                                    @Html.ActionLink( "Sell", "Sell", new TradeModel { CompanySymbol = item.CompanySymbol }, new { data_modal = "", @class = "btn btn-block no-rounded-btn btn-danger btn-lg" } )
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

        }

    </div>
</div>

@*<div class="container row ">
        <div class=" bg-darkCobalt tile text-center padding20 ">
            <h2 class="fg-white">@Html.ActionLink("Add Observer", "Create")</h2>
        </div>
    </div>*@


